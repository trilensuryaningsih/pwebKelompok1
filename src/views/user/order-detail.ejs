<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UMCental - Detail Pesanan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <style>
        .bg-custom-dark {
            background-color: #181C14;
        }

        .bg-custom-green {
            background-color: #697565;
        }

        .text-custom-green {
            color: #697565;
        }

        .border-custom-green {
            border-color: #697565;
        }

        .bg-custom-light-beige {
            background-color: #f5f0e9;
        }

        .text-custom-brown {
            color: #7f7a75;
        }

        .hover\:bg-custom-green-dark:hover {
            background-color: #5a6356;
        }

        .skeleton {
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .status-rejected {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }

        .status-active {
            background-color: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .status-cancelled {
            background-color: #f3f4f6;
            color: #374151;
            border-color: #9ca3af;
        }
    </style>
</head>

<body class="flex min-h-screen bg-custom-light-beige">

    <%- include('../partials/sidebar') %>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <%- include('../partials/header') %>

        <main class="flex-1 p-6 md:p-10">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="mb-8">
                    <a href="/user/orders" class="text-sm text-custom-green hover:underline mb-4 inline-block">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar Pesanan
                    </a>
                    <h1 class="text-3xl font-bold text-custom-dark">Detail Pesanan <span id="orderIdHeader" class="text-custom-brown"></span></h1>
                </div>

                <!-- Skeleton Loader -->
                <div id="skeletonLoader">
                    <div class="h-24 w-full skeleton mb-6"></div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="h-64 w-full skeleton"></div>
                        <div class="h-64 w-full skeleton"></div>
                    </div>
                </div>

                <!-- Order Detail Content -->
                <div id="orderDetailContent" class="hidden">
                    <!-- Order Status Banner -->
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <h2 class="text-xl font-semibold text-custom-dark mb-2">Status Pesanan</h2>
                                <span id="orderStatus" class="inline-block rounded-full px-4 py-2 font-semibold text-sm"></span>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-custom-brown">Total Pembayaran</p>
                                <p id="totalAmount" class="text-2xl font-bold text-custom-dark"></p>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Left Column: Item Details & Dates -->
                        <div>
                            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6">
                                <h3 class="text-lg font-semibold text-custom-dark mb-4 border-b pb-3">Rincian Barang/Jasa</h3>
                                <dl class="space-y-3">
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Nama:</dt><dd id="itemName" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Kategori:</dt><dd id="itemCategory" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Harga Satuan:</dt><dd id="pricePerUnit" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Jumlah:</dt><dd id="quantity" class="text-sm font-medium text-right"></dd></div>
                                    <div class="pt-3 border-t"><dt class="text-sm text-custom-brown">Deskripsi:</dt><dd id="itemDescription" class="mt-1 text-sm text-gray-600"></dd></div>
                                </dl>
                            </div>
                            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                                <h3 class="text-lg font-semibold text-custom-dark mb-4 border-b pb-3">Jadwal Peminjaman</h3>
                                <dl class="space-y-3">
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Tanggal Pinjam:</dt><dd id="startDate" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Tanggal Kembali:</dt><dd id="endDate" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Durasi:</dt><dd id="duration" class="text-sm font-medium text-right"></dd></div>
                                </dl>
                            </div>
                            
                            <!-- Order Information -->
                            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                                <h3 class="text-lg font-semibold text-custom-dark mb-4 border-b pb-3">Informasi Pesanan</h3>
                                <dl class="space-y-3">
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Order ID:</dt><dd id="orderId" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Tanggal Pesanan:</dt><dd id="orderDate" class="text-sm font-medium text-right"></dd></div>
                                    <div class="flex justify-between"><dt class="text-sm text-custom-brown">Tipe:</dt><dd id="itemType" class="text-sm font-medium text-right"></dd></div>
                                    <div class="pt-3 border-t"><dt class="text-sm text-custom-brown">Catatan:</dt><dd id="notes" class="mt-1 text-sm text-gray-600"></dd></div>
                                </dl>
                            </div>
                        </div>

                        <!-- Right Column: Payment & Fine -->
                        <div class="space-y-6">
                            <!-- Payment Section -->
                            <div id="paymentSection"></div>
                            
                            <!-- Fine Section -->
                            <div id="fineSection"></div>
                            
                            <!-- Action Buttons -->
                            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                                <h3 class="text-lg font-semibold text-custom-dark mb-4 border-b pb-3">Aksi</h3>
                                <div class="flex flex-wrap gap-3">
                                    <button id="printBtn" class="px-4 py-2 bg-custom-green text-white rounded-lg hover:bg-custom-green-dark transition-colors">
                                        <i class="fas fa-print mr-2"></i>Cetak
                                    </button>
                                    <button id="editOrderBtn" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-edit mr-2"></i>Edit
                                    </button>
                                    <button id="cancelOrderBtn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Batalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Error State -->
                <div id="errorState" class="hidden text-center py-16 px-6">
                    <div class="mx-auto h-16 w-16 text-red-400">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                    </div>
                    <h3 class="mt-4 text-lg font-medium text-custom-dark">Terjadi Kesalahan</h3>
                    <p class="mt-1 text-sm text-custom-brown">Gagal memuat detail pesanan.</p>
                </div>
            </div>
        </main>

        <%- include('../partials/footer') %>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-[#181C14] mb-4">Batalkan Pesanan</h3>
            <p class="text-[#7f7a75] mb-6">Apakah Anda yakin ingin membatalkan pesanan ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex gap-3 justify-end">
                <button id="cancelModalClose" class="px-4 py-2 text-[#7f7a75] border border-[#d1d5db] rounded-lg hover:bg-[#f9fafb] transition">
                    Batal
                </button>
                <button id="confirmCancel" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Ya, Batalkan
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentOrder = null;

        // Load order detail on page load
        document.addEventListener('DOMContentLoaded', function() {
            const orderId = getOrderIdFromUrl();
            if (orderId) {
                loadOrderDetail(orderId);
            } else {
                showError('ID pesanan tidak valid');
            }
        });

        // Get order ID from URL
        function getOrderIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }

        // Load order detail from API
        async function loadOrderDetail(orderId) {
            const loadingState = document.getElementById('skeletonLoader');
            const errorState = document.getElementById('errorState');
            const orderDetailContent = document.getElementById('orderDetailContent');

            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            orderDetailContent.classList.add('hidden');

            try {
                const response = await fetch(`/user/api/orders/${orderId}`);
                const result = await response.json();

                if (result.success) {
                    currentOrder = result.data;
                    displayOrderDetail(currentOrder);
                } else {
                    showError(result.message || 'Gagal memuat detail pesanan');
                }
            } catch (error) {
                console.error('Error loading order detail:', error);
                showError('Terjadi kesalahan saat memuat detail pesanan');
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        // Display order detail
        function displayOrderDetail(order) {
            const orderDetailContent = document.getElementById('orderDetailContent');
            
            // Set basic information
            document.getElementById('orderIdHeader').textContent = `#${order.id}`;
            document.getElementById('orderId').textContent = order.id;
            document.getElementById('itemType').textContent = order.itemType === 'item' ? 'Barang' : 'Layanan';
            document.getElementById('quantity').textContent = order.quantity;
            document.getElementById('totalAmount').textContent = `Rp ${formatNumber(order.totalAmount)}`;
            document.getElementById('orderDate').textContent = formatDate(order.createdAt);
            document.getElementById('startDate').textContent = formatDate(order.startDate);
            document.getElementById('endDate').textContent = formatDate(order.endDate);
            document.getElementById('duration').textContent = calculateDuration(order.startDate, order.endDate);

            // Set status
            const statusElement = document.getElementById('orderStatus');
            statusElement.textContent = getStatusText(order.status);
            statusElement.className = `inline-block rounded-full px-4 py-2 font-semibold text-sm ${getStatusClass(order.status)}`;

            // Set notes
            const notesElement = document.getElementById('notes');
            if (order.notes) {
                notesElement.textContent = order.notes;
            } else {
                notesElement.innerHTML = '<em class="text-gray-400">Tidak ada catatan</em>';
            }

            // Set item details if available
            if (order.itemDetails) {
                document.getElementById('itemName').textContent = order.itemDetails.name || 'N/A';
                document.getElementById('itemDescription').textContent = order.itemDetails.description || 'Tidak ada deskripsi';
                document.getElementById('itemCategory').textContent = order.itemDetails.category || 'Tidak ada kategori';
                document.getElementById('pricePerUnit').textContent = `Rp ${formatNumber(order.itemDetails.price)}`;
            } else {
                document.getElementById('itemName').textContent = 'N/A';
                document.getElementById('itemDescription').textContent = 'Tidak ada deskripsi';
                document.getElementById('itemCategory').textContent = 'Tidak ada kategori';
                document.getElementById('pricePerUnit').textContent = 'Rp 0';
            }

            // Show/hide action buttons based on status
            const cancelOrderBtn = document.getElementById('cancelOrderBtn');
            const editOrderBtn = document.getElementById('editOrderBtn');

            if (order.status === 'pending') {
                cancelOrderBtn.classList.remove('hidden');
                editOrderBtn.classList.remove('hidden');
            } else {
                cancelOrderBtn.classList.add('hidden');
                editOrderBtn.classList.add('hidden');
            }

            // Load payment
            loadPayment(order.id);

            // Load fine
            loadFine(order.id);

            orderDetailContent.classList.remove('hidden');
        }

        // Show error state
        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorMessage = errorState.querySelector('p');
            errorMessage.textContent = message;
            errorState.classList.remove('hidden');
        }

        // Calculate duration between dates
        function calculateDuration(startDate, endDate) {
            if (!startDate || !endDate) return '-';
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return `${diffDays} hari`;
        }

        // Download file
        function downloadFile(filename) {
            // This would typically trigger a file download
            window.open(`/uploads/${filename}`, '_blank');
        }

        // Print order detail
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });

        // Cancel order functionality
        document.getElementById('cancelOrderBtn').addEventListener('click', function() {
            document.getElementById('cancelModal').classList.remove('hidden');
        });

        document.getElementById('confirmCancel').addEventListener('click', async function() {
            if (!currentOrder) return;

            try {
                const response = await fetch(`/user/api/orders/${currentOrder.id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert('Pesanan berhasil dibatalkan');
                    window.location.href = '/user/orders';
                } else {
                    alert('Gagal membatalkan pesanan: ' + result.message);
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('Terjadi kesalahan saat membatalkan pesanan');
            } finally {
                document.getElementById('cancelModal').classList.add('hidden');
            }
        });

        document.getElementById('cancelModalClose').addEventListener('click', function() {
            document.getElementById('cancelModal').classList.add('hidden');
        });

        // Edit order functionality
        document.getElementById('editOrderBtn').addEventListener('click', function() {
            if (currentOrder) {
                window.location.href = `/user/orders/${currentOrder.id}/edit`;
            }
        });

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatNumber(num) {
            if (!num) return '0';
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function getStatusClass(status) {
            const statusClasses = {
                pending: 'status-pending',
                approved: 'status-approved',
                rejected: 'status-rejected',
                active: 'status-active',
                completed: 'status-completed',
                cancelled: 'status-cancelled'
            };
            return statusClasses[status] || 'status-pending';
        }

        function getStatusText(status) {
            const statusTexts = {
                pending: 'Menunggu',
                approved: 'Disetujui',
                rejected: 'Ditolak',
                active: 'Aktif',
                completed: 'Selesai',
                cancelled: 'Dibatalkan'
            };
            return statusTexts[status] || status;
        }

        // Payment status helper functions
        function getPaymentStatusClass(status) {
            const statusClasses = {
                pending: 'text-yellow-600',
                paid: 'text-green-600',
                failed: 'text-red-600',
                refunded: 'text-gray-600'
            };
            return statusClasses[status] || 'text-gray-600';
        }

        function getPaymentStatusText(status) {
            const statusTexts = {
                pending: 'Menunggu',
                paid: 'Dibayar',
                failed: 'Gagal',
                refunded: 'Dikembalikan'
            };
            return statusTexts[status] || status;
        }

        // Tambahkan fungsi untuk load payment
        async function loadPayment(orderId) {
            const paymentSection = document.getElementById('paymentSection');
            paymentSection.innerHTML = '';
            
            try {
                const res = await fetch(`/user/orders/${orderId}/payment`);
                const result = await res.json();
                
                if (result.success && result.data) {
                    // Sudah ada pembayaran
                    const payment = result.data;
                    paymentSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                            <h3 class="text-lg font-semibold text-[#181C14] mb-4">Pembayaran</h3>
                            <div class="mb-2">Metode: <span class="font-medium">${payment.paymentMethod}</span></div>
                            <div class="mb-2">Tanggal: <span class="font-medium">${formatDate(payment.paymentDate)}</span></div>
                            <div class="mb-2">Tipe: <span class="font-medium">${payment.paymentType}</span></div>
                            <div class="mb-2">Status: <span class="font-medium ${getPaymentStatusClass(payment.status)}">${getPaymentStatusText(payment.status)}</span></div>
                            <div class="mb-2">Bukti: <a href="/uploads/${payment.paymentProof}" target="_blank" class="text-blue-600 underline">Lihat Bukti</a></div>
                        </div>
                    `;
                } else if (currentOrder.status === 'approved') {
                    // Belum ada pembayaran dan status approved, tampilkan form
                    paymentSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                            <h3 class="text-lg font-semibold text-[#181C14] mb-4">Upload Bukti Pembayaran</h3>
                            <p class="text-sm text-gray-600 mb-4">Pesanan Anda telah disetujui. Silakan lakukan pembayaran dan upload bukti pembayaran.</p>
                            <form id="paymentForm" enctype="multipart/form-data">
                                <div class="mb-4">
                                    <label class="block mb-1 font-medium">Metode Pembayaran</label>
                                    <select name="paymentMethod" class="w-full border rounded px-3 py-2" required>
                                        <option value="">Pilih Metode</option>
                                        <option value="Transfer">Transfer Bank</option>
                                        <option value="QRIS">QRIS</option>
                                        <option value="Tunai">Tunai</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-1 font-medium">Tipe Pembayaran</label>
                                    <select name="paymentType" class="w-full border rounded px-3 py-2" required>
                                        <option value="">Pilih Tipe</option>
                                        <option value="full">Lunas</option>
                                        <option value="deposit">DP</option>
                                        <option value="installment">Cicilan</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-1 font-medium">Bukti Pembayaran</label>
                                    <input type="file" name="paymentProof" accept="image/*,application/pdf" class="w-full border rounded px-3 py-2" required />
                                    <p class="text-xs text-gray-500 mt-1">Upload bukti pembayaran dalam format JPG, PNG, atau PDF</p>
                                </div>
                                <button type="submit" class="px-6 py-2 bg-[#697565] text-white rounded-lg hover:bg-[#5a6356] transition">
                                    <i class="fas fa-upload mr-2"></i>Upload Bukti Pembayaran
                                </button>
                            </form>
                        </div>
                    `;
                    
                    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        
                        try {
                            const res = await fetch(`/user/orders/${orderId}/payment`, {
                                method: 'POST',
                                body: formData
                            });
                            const result = await res.json();
                            
                            if (result.success) {
                                alert('Bukti pembayaran berhasil diupload!');
                                // Refresh halaman untuk menampilkan status terbaru
                                window.location.reload();
                            } else {
                                alert(result.message || 'Gagal upload pembayaran');
                            }
                        } catch (error) {
                            console.error('Error uploading payment:', error);
                            alert('Terjadi kesalahan saat upload pembayaran');
                        }
                    });
                } else if (currentOrder.status === 'pending') {
                    // Status masih pending
                    paymentSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                            <h3 class="text-lg font-semibold text-[#181C14] mb-4">Pembayaran</h3>
                            <div class="text-center py-4">
                                <i class="fas fa-clock text-yellow-500 text-3xl mb-2"></i>
                                <p class="text-gray-600">Pesanan masih dalam status menunggu persetujuan.</p>
                                <p class="text-sm text-gray-500 mt-1">Pembayaran dapat dilakukan setelah pesanan disetujui.</p>
                            </div>
                        </div>
                    `;
                } else if (currentOrder.status === 'rejected') {
                    // Status ditolak
                    paymentSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                            <h3 class="text-lg font-semibold text-[#181C14] mb-4">Pembayaran</h3>
                            <div class="text-center py-4">
                                <i class="fas fa-times-circle text-red-500 text-3xl mb-2"></i>
                                <p class="text-gray-600">Pesanan ditolak.</p>
                                <p class="text-sm text-gray-500 mt-1">Tidak dapat melakukan pembayaran untuk pesanan yang ditolak.</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Status lainnya (active, completed, cancelled)
                    paymentSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                            <h3 class="text-lg font-semibold text-[#181C14] mb-4">Pembayaran</h3>
                            <div class="text-center py-4">
                                <i class="fas fa-info-circle text-blue-500 text-3xl mb-2"></i>
                                <p class="text-gray-600">Status pesanan: ${getStatusText(currentOrder.status)}</p>
                                <p class="text-sm text-gray-500 mt-1">Pembayaran hanya tersedia untuk pesanan yang disetujui.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error loading payment:', err);
                paymentSection.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                        <h3 class="text-lg font-semibold text-[#181C14] mb-4">Pembayaran</h3>
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-2"></i>
                            <p class="text-red-600">Gagal memuat data pembayaran</p>
                        </div>
                    </div>
                `;
            }
        }

        // Tambahkan fungsi untuk load fine (denda)
        async function loadFine(orderId) {
            const fineSection = document.getElementById('fineSection');
            fineSection.innerHTML = '';
            try {
                const res = await fetch(`/user/orders/${orderId}/fine`);
                const result = await res.json();
                if (result.success && result.data) {
                    const fine = result.data;
                    if (fine.status === 'paid') {
                        fineSection.innerHTML = `
                            <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                                <h3 class="text-lg font-semibold text-red-700 mb-4">Denda Keterlambatan</h3>
                                <div class="mb-2">Jumlah Denda: <span class="font-medium text-red-700">Rp ${fine.amount.toLocaleString('id-ID')}</span></div>
                                <div class="mb-2">Tanggal Denda: <span class="font-medium">${new Date(fine.createdAt).toLocaleString('id-ID')}</span></div>
                                <div class="mb-2">Keterangan: <span class="font-medium">${fine.description || '-'}</span></div>
                                <div class="mb-2">Status: <span class="font-medium text-green-700">Sudah Dibayar</span></div>
                                <div class="mb-2">Metode: <span class="font-medium">${fine.paymentMethod}</span></div>
                                <div class="mb-2">Tanggal Bayar: <span class="font-medium">${fine.paymentDate ? new Date(fine.paymentDate).toLocaleString('id-ID') : '-'}</span></div>
                                <div class="mb-2">Bukti Bayar: <a href="/uploads/${fine.paymentProof}" target="_blank" class="text-blue-600 underline">Lihat Bukti</a></div>
                            </div>
                        `;
                    } else {
                        fineSection.innerHTML = `
                            <div class="bg-white rounded-lg shadow-sm border border-[#e5e7eb] p-6 mb-6">
                                <h3 class="text-lg font-semibold text-red-700 mb-4">Denda Keterlambatan</h3>
                                <div class="mb-2">Jumlah Denda: <span class="font-medium text-red-700">Rp ${fine.amount.toLocaleString('id-ID')}</span></div>
                                <div class="mb-2">Tanggal Denda: <span class="font-medium">${new Date(fine.createdAt).toLocaleString('id-ID')}</span></div>
                                <div class="mb-2">Keterangan: <span class="font-medium">${fine.description || '-'}</span></div>
                                <div class="mb-2">Status: <span class="font-medium text-yellow-700">Belum Dibayar</span></div>
                                <form id="finePaymentForm" class="mt-4" enctype="multipart/form-data">
                                    <div class="mb-4">
                                        <label class="block mb-1 font-medium">Metode Pembayaran Denda</label>
                                        <select name="paymentMethod" class="w-full border rounded px-3 py-2" required>
                                            <option value="">Pilih Metode</option>
                                            <option value="Transfer">Transfer Bank</option>
                                            <option value="QRIS">QRIS</option>
                                            <option value="Tunai">Tunai</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block mb-1 font-medium">Bukti Pembayaran Denda</label>
                                        <input type="file" name="paymentProof" accept="image/*,application/pdf" class="w-full border rounded px-3 py-2" required />
                                    </div>
                                    <button type="submit" class="px-6 py-2 bg-[#697565] text-white rounded-lg hover:bg-[#5a6356] transition">Upload Bukti Pembayaran Denda</button>
                                </form>
                            </div>
                        `;
                        document.getElementById('finePaymentForm').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            const formData = new FormData(this);
                            const res = await fetch(`/user/orders/${orderId}/fine/payment`, {
                                method: 'POST',
                                body: formData
                            });
                            const result = await res.json();
                            if (result.success) {
                                alert('Bukti pembayaran denda berhasil diupload!');
                                loadFine(orderId);
                            } else {
                                alert(result.message || 'Gagal upload pembayaran denda');
                            }
                        });
                    }
                }
            } catch (err) {
                fineSection.innerHTML = '<div class="text-red-600">Gagal memuat data denda</div>';
            }
        }
    </script>
</body>

</html> 