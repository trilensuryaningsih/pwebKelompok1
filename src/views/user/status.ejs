<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UMCental Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <style>
        .bg-custom-dark {
            background-color: #181C14;
        }

        .bg-custom-green {
            background-color: #697565;
        }

        .bg-custom-green-dark {
            background-color: #5a6356;
        }

        .focus\:ring-custom-green:focus {
            --tw-ring-color: rgba(105, 117, 101, 0.5);

            
        }
    </style>
</head>

<body class="flex min-h-screen bg-[#f5f0e9] ">

    <%- include('../partials/sidebar') %>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <%- include('../partials/header') %>

                <!-- Content -->
                <section class="flex-1 p-8 overflow-x-auto">
     <table class="min-w-full border-collapse">
      <thead>
       <tr class="bg-[#7f8a7d] rounded-lg text-[#e6e1d9] text-xs font-normal">
        <th class="py-3 px-4 text-left rounded-l-lg">
         No
        </th>
        <th class="py-3 px-4 text-left">
         Kode Pesanan
        </th>
        <th class="py-3 px-4 text-left">
         Tanggal Pemesanan
        </th>
        <th class="py-3 px-4 text-left">
         Tanggal Peminjaman
        </th>
        <th class="py-3 px-4 text-left">
         Tanggal Pengembalian
        </th>
        <th class="py-3 px-4 text-left">
         Status
        </th>
        <th class="py-3 px-4 text-left">
         MOU
        </th>
        <th class="py-3 px-4 text-left">
         Catatan
        </th>
        <th class="py-3 px-4 text-left rounded-r-lg">
         Aksi
        </th>
       </tr>
      </thead>
      <tbody class="text-[#7f7a75] text-sm font-normal">
      <% if (orders && orders.length > 0) { %>
        <% orders.forEach(function(order, idx) { %>
        <tr class="border-b border-[#f0ebe0]">
          <td class="py-6 px-4"><%= idx + 1 %></td>
          <td class="py-6 px-4">#<%= order.id %></td>
          <td class="py-6 px-4"><%= order.createdAt ? order.createdAt.toLocaleDateString('id-ID') : '-' %></td>
          <td class="py-6 px-4"><%= order.startDate ? new Date(order.startDate).toLocaleDateString('id-ID') : '-' %></td>
          <td class="py-6 px-4"><%= order.endDate ? new Date(order.endDate).toLocaleDateString('id-ID') : '-' %></td>
          <td class="py-6 px-4">
            <% let statusColor = {
              pending: 'bg-yellow-100 border-yellow-400 text-yellow-700',
              approved: 'bg-blue-100 border-blue-400 text-blue-700',
              rejected: 'bg-red-200 border-red-500 text-red-800',
              active: 'bg-green-100 border-green-400 text-green-700',
              completed: 'bg-gray-200 border-gray-400 text-gray-700',
              cancelled: 'bg-gray-400 border-gray-700 text-gray-900',
              exchange_requested: 'bg-purple-100 border-purple-400 text-purple-700'
            }[order.status] || 'bg-white border-gray-300 text-gray-700'; %>
            <span class="inline-block border font-semibold rounded-full px-4 py-1 select-none <%= statusColor %>">
              <%= order.status %>
            </span>
          </td>
          <td class="py-6 px-4">
            <% if (order.mouFile) { %>
              <a href="<%= order.mouFile %>" target="_blank" class="text-blue-600 underline">Lihat MOU</a>
            <% } else { %>
              -
            <% } %>
          </td>
          <td class="py-6 px-4">
            <% if (order.notes) { %>
              <span class="block text-xs text-gray-500"><%= order.notes %></span>
            <% } else { %>
              -
            <% } %>
          </td>
          <td class="py-6 px-4">
            <button class="mt-2 bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1 text-xs <%= !(['pending','approved'].includes(order.status)) ? 'opacity-50 cursor-not-allowed' : '' %>" <%= !(['pending','approved'].includes(order.status)) ? 'disabled' : '' %> onclick="batalkanOrder(<%= order.id %>)">Batalkan</button>
            <button class="mt-2 bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 text-xs <%= order.status !== 'active' ? 'opacity-50 cursor-not-allowed' : '' %>" <%= order.status !== 'active' ? 'disabled' : '' %>>Ajukan Pengembalian</button>
          </td>
        </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="9" class="text-center py-8">Belum ada pesanan.</td></tr>
      <% } %>
      </tbody>
     </table>
    </section>
    <%- include('../partials/footer') %>  
  </div>            
</body>

<script>
function batalkanOrder(id) {
  const btn = event.currentTarget;
  if(btn.disabled) return;
  if(confirm('Yakin ingin membatalkan pesanan ini?')) {
    fetch(`/user/orders/${id}/cancel`, {method:'POST',headers:{'Content-Type':'application/json'}})
      .then(r=>r.json()).then(res=>{
        if(res.success) location.reload();
        else alert(res.message||'Gagal membatalkan pesanan');
      });
  }
}
function exchangeOrder(id) {
  if(confirm('Ajukan penukaran alat untuk pesanan ini?')) {
    fetch(`/user/status/${id}/exchange`, {method:'POST',headers:{'Content-Type':'application/json'}})
      .then(r=>r.json()).then(res=>{
        if(res.success) location.reload();
        else alert(res.message||'Gagal mengajukan penukaran');
      });
  }
}
</script>

</html>